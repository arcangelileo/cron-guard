{% extends "base.html" %}
{% block title %}Settings â€” CronGuard{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto fade-in">
    <h1 class="text-2xl font-bold text-gray-900 mb-1">Settings</h1>
    <p class="text-sm text-gray-500 mb-8">Manage your account, notifications, and API access.</p>

    {% if success %}
    <div class="mb-6 bg-green-50 border border-green-200 rounded-lg p-4 fade-in">
        <p class="text-sm text-green-700 flex items-center gap-2">
            <svg class="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
            {{ success }}
        </p>
    </div>
    {% endif %}

    {% if errors %}
    <div class="mb-6 bg-red-50 border border-red-200 rounded-lg p-4 fade-in">
        {% for error in errors %}
        <p class="text-sm text-red-700 flex items-center gap-2">
            <svg class="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" /></svg>
            {{ error }}
        </p>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Account Info -->
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm mb-6">
        <div class="px-6 py-5 border-b border-gray-100">
            <h2 class="text-sm font-semibold text-gray-900">Account Info</h2>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Username</p>
                    <p class="text-sm text-gray-900 mt-1 font-medium">{{ user.username }}</p>
                </div>
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Email</p>
                    <p class="text-sm text-gray-900 mt-1">{{ user.email }}</p>
                </div>
                <div>
                    <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Member since</p>
                    <p class="text-sm text-gray-900 mt-1">{{ user.created_at.strftime('%B %d, %Y') }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Preferences -->
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm mb-6">
        <div class="px-6 py-5 border-b border-gray-100">
            <h2 class="text-sm font-semibold text-gray-900">Alert Preferences</h2>
        </div>
        <form method="POST" action="/settings/profile" class="p-6 space-y-5">
            <div>
                <label for="alert_email" class="block text-sm font-medium text-gray-700 mb-1.5">Alert Email</label>
                <input type="email" id="alert_email" name="alert_email"
                    value="{{ user.alert_email or user.email }}"
                    class="input-field"
                    placeholder="Where to send alerts (defaults to account email)">
            </div>

            <div class="flex items-center gap-3">
                <input type="checkbox" id="email_alerts_enabled" name="email_alerts_enabled" value="on"
                    {% if user.email_alerts_enabled %}checked{% endif %}
                    class="w-4 h-4 text-brand-600 border-gray-300 rounded focus:ring-brand-500 cursor-pointer">
                <label for="email_alerts_enabled" class="text-sm text-gray-700 cursor-pointer">Enable email alerts for down/recovery notifications</label>
            </div>

            <div class="flex justify-end pt-2">
                <button type="submit" class="btn-primary">
                    Save Preferences
                </button>
            </div>
        </form>
    </div>

    <!-- Change Password -->
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm mb-6">
        <div class="px-6 py-5 border-b border-gray-100">
            <h2 class="text-sm font-semibold text-gray-900">Change Password</h2>
        </div>
        <form method="POST" action="/settings/password" class="p-6 space-y-5">
            <div>
                <label for="current_password" class="block text-sm font-medium text-gray-700 mb-1.5">Current Password</label>
                <input type="password" id="current_password" name="current_password" required
                    class="input-field">
            </div>
            <div>
                <label for="new_password" class="block text-sm font-medium text-gray-700 mb-1.5">New Password</label>
                <input type="password" id="new_password" name="new_password" required minlength="8"
                    class="input-field"
                    placeholder="At least 8 characters">
            </div>
            <div>
                <label for="new_password_confirm" class="block text-sm font-medium text-gray-700 mb-1.5">Confirm New Password</label>
                <input type="password" id="new_password_confirm" name="new_password_confirm" required minlength="8"
                    class="input-field">
            </div>
            <div class="flex justify-end pt-2">
                <button type="submit" class="btn-primary">
                    Update Password
                </button>
            </div>
        </form>
    </div>

    <!-- API Key -->
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm mb-6">
        <div class="px-6 py-5 border-b border-gray-100">
            <h2 class="text-sm font-semibold text-gray-900">API Key</h2>
        </div>
        <div class="p-6">
            <p class="text-sm text-gray-500 mb-3">Use this key to authenticate API requests. Pass it in the <code class="bg-gray-100 px-1.5 py-0.5 rounded text-xs font-mono text-gray-700">X-Api-Key</code> header.</p>
            <div class="flex items-center gap-2 mb-4">
                <code class="flex-1 bg-gray-50 border border-gray-200 rounded-lg px-4 py-2.5 text-sm font-mono text-gray-800 truncate select-all" id="api-key">{{ user.api_key }}</code>
                <button onclick="navigator.clipboard.writeText(document.getElementById('api-key').textContent.trim()).then(() => { this.textContent = 'Copied!'; setTimeout(() => this.textContent = 'Copy', 1500); })"
                    class="px-4 py-2.5 text-sm font-medium text-brand-600 bg-brand-50 hover:bg-brand-100 rounded-lg transition-colors whitespace-nowrap">
                    Copy
                </button>
            </div>
            <form method="POST" action="/settings/api-key"
                onsubmit="return confirm('Are you sure? Existing integrations using the current key will stop working.')">
                <button type="submit"
                    class="text-sm font-medium text-red-600 hover:text-red-700 hover:underline transition-colors">
                    Regenerate API Key
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}
